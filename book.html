<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Book a 30-minute meeting with Gaurav and Justin at Meridian Cambridge.">
  <title>Book a Meeting | Meridian Cambridge</title>

  <link rel="icon" type="image/png" href="/images/favicon.png">
  <link rel="apple-touch-icon" href="/images/favicon.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Space+Mono:wght@400&display=swap" rel="stylesheet">

  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --red:        #7e4233;
      --red-mid:    #a65d4a;
      --red-tint:   rgba(126, 66, 51, 0.07);
      --red-ring:   rgba(126, 66, 51, 0.2);
      --black:      #111;
      --ink:        #333;
      --muted:      #777;
      --border:     #e4e4e4;
      --surface:    #f8f7f4;
      --white:      #fff;
      --serif:      'Libre Baskerville', Georgia, serif;
      --mono:       'Space Mono', monospace;
      --radius:     18px;
    }

    html { font-size: 16px; -webkit-font-smoothing: antialiased; height: 100%; }

    body {
      font-family: var(--mono);
      background: #f0efec;
      color: var(--black);
      height: 100%;
      overflow: hidden;
    }

    /* Subtle grain */
    body::before {
      content: '';
      position: fixed; inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      opacity: 0.02;
      pointer-events: none;
      z-index: 1000;
    }

    /* ── Page wrapper ────────────────────────────────── */
    .page {
      height: 100vh;
      display: flex; align-items: stretch;
    }

    /* ── Shell (full-screen two-column) ──────────────── */
    .shell {
      display: grid;
      grid-template-columns: 260px 1fr;
      width: 100%;
      background: var(--white);
      overflow: hidden;
    }

    /* ── Left: info ──────────────────────────────────── */
    .info {
      background: var(--surface);
      border-right: 1px solid var(--border);
      padding: 2rem 1.75rem;
      display: flex; flex-direction: column; gap: 1.25rem;
      height: 100vh; overflow-y: auto;
    }

    .info-logo { height: 26px; opacity: 0.8; display: block; }

    .info-label {
      font-size: 0.6rem; letter-spacing: 0.3em;
      text-transform: uppercase; color: var(--muted);
    }

    .info-names {
      font-family: var(--serif);
      font-size: 1.45rem; font-weight: 400;
      line-height: 1.2; color: var(--black);
    }

    .info-org { font-size: 0.75rem; color: var(--muted); margin-top: 0.2rem; }

    .info-rule { border: none; border-top: 1px solid var(--border); }

    .info-meta { list-style: none; display: flex; flex-direction: column; gap: 0.65rem; }
    .info-meta li {
      display: flex; align-items: center; gap: 0.55rem;
      font-size: 0.76rem; color: var(--ink);
    }
    .info-meta svg { flex-shrink: 0; color: var(--muted); }

    .info-desc {
      font-size: 0.78rem; color: var(--ink); line-height: 1.75;
    }

    .info-footer {
      font-size: 0.68rem; color: var(--muted); line-height: 1.6;
      border-top: 1px solid var(--border); padding-top: 1rem; margin-top: auto;
    }

    /* ── Right: widget ───────────────────────────────── */
    .widget {
      padding: 2.5rem 2.75rem 2rem;
      height: 100vh; overflow-y: auto;
      display: flex; flex-direction: column;
    }

    /* Breadcrumb */
    .crumbs {
      display: flex; align-items: center; gap: 0.4rem;
      margin-bottom: 1.5rem;
      font-size: 0.64rem; letter-spacing: 0.1em; text-transform: uppercase;
    }
    .crumb       { color: var(--border); transition: color 0.2s; }
    .crumb.done  { color: var(--muted); }
    .crumb.here  { color: var(--red); }
    .crumb-sep   { color: var(--border); font-size: 0.8rem; }

    /* Steps */
    .step { display: none; }
    .step.on {
      display: flex; flex-direction: column;
      flex: 1; min-height: 0;
      animation: fadeUp 0.22s ease-out;
    }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .step-back {
      display: inline-flex; align-items: center; gap: 0.3rem;
      font-family: var(--mono); font-size: 0.72rem;
      color: var(--muted); background: none; border: none;
      cursor: pointer; padding: 0; margin-bottom: 1.5rem;
      transition: color 0.15s;
    }
    .step-back:hover { color: var(--black); }

    .step-title {
      font-family: var(--serif); font-size: 1.25rem; font-weight: 400;
      color: var(--black); margin-bottom: 0.35rem;
    }

    .step-sub {
      font-size: 0.76rem; color: var(--muted); margin-bottom: 1.25rem;
    }

    /* ── Calendar ────────────────────────────────────── */
    .cal-header {
      display: flex; align-items: center;
      justify-content: space-between; margin-bottom: 0.75rem;
    }

    .cal-title {
      font-family: var(--serif); font-size: 1rem; font-weight: 400;
    }

    .cal-btn {
      width: 30px; height: 30px; border-radius: 50%;
      border: 1px solid var(--border); background: none;
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem; color: var(--muted); cursor: pointer;
      transition: border-color 0.15s, color 0.15s;
    }
    .cal-btn:hover:not(:disabled) { border-color: var(--red); color: var(--red); }
    .cal-btn:disabled { opacity: 0.25; cursor: not-allowed; }

    /* Grid — fills full widget width and remaining height */
    .cal-grid {
      display: grid; grid-template-columns: repeat(7, 1fr);
      grid-template-rows: 36px; grid-auto-rows: 1fr;
      gap: 3px; width: 100%;
      flex: 1; min-height: 0;
    }

    .cal-dh {
      display: flex; align-items: center; justify-content: center;
      font-size: 0.6rem; letter-spacing: 0.06em;
      text-transform: uppercase; color: var(--muted);
    }

    .cal-day {
      display: flex; align-items: center; justify-content: center;
      border-radius: 6px;
      font-size: 0.82rem; font-family: var(--mono);
      border: none; background: none; cursor: default;
      color: #ccc; transition: background 0.12s, color 0.12s, box-shadow 0.12s;
    }

    .cal-day.avail {
      color: var(--black); cursor: pointer;
    }
    .cal-day.avail:hover {
      background: var(--red-tint); color: var(--red);
    }
    .cal-day.avail.sel {
      background: var(--red); color: #fff;
    }
    .cal-day.avail.sel:hover { background: var(--red-mid); }

    .cal-day.ring {
      box-shadow: inset 0 0 0 1px var(--border);
    }

    /* ── Time slots ──────────────────────────────────── */
    .times {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-auto-rows: 1fr;
      gap: 0.5rem;
      margin-top: 0.25rem;
      flex: 1; min-height: 0;
    }

    .t-btn {
      display: flex; align-items: center; justify-content: center;
      border: 1px solid var(--border); border-radius: 8px;
      background: var(--white); font-family: var(--mono);
      font-size: 0.82rem; color: var(--ink);
      cursor: pointer; width: 100%; height: 100%;
      transition: border-color 0.14s, color 0.14s, background 0.14s;
    }
    .t-btn:hover {
      border-color: var(--red); color: var(--red);
      background: var(--red-tint);
    }
    .t-btn .t-arrow { display: none; }

    .tz {
      font-size: 0.67rem; color: var(--muted);
      margin-top: 0.75rem; flex-shrink: 0;
    }

    .t-loading {
      font-size: 0.8rem; color: var(--muted);
      animation: pulse 1.2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.4; }
    }

    /* ── Form ────────────────────────────────────────── */
    .hp {
      position: absolute; left: -9999px; opacity: 0;
      height: 0; pointer-events: none; overflow: hidden;
    }

    .fields { display: flex; flex-direction: column; gap: 1rem; }

    .field label {
      display: block; font-size: 0.67rem; letter-spacing: 0.09em;
      text-transform: uppercase; color: var(--muted); margin-bottom: 0.4rem;
    }
    .field label .req { color: var(--red); }

    .field input,
    .field textarea {
      display: block; width: 100%;
      padding: 0.65rem 0.85rem;
      border: 1px solid var(--border); border-radius: 8px;
      background: var(--white); color: var(--black);
      font-family: var(--mono); font-size: 0.86rem;
      outline: none; transition: border-color 0.14s, box-shadow 0.14s;
    }
    .field input:focus,
    .field textarea:focus {
      border-color: var(--red);
      box-shadow: 0 0 0 3px var(--red-tint);
    }
    .field textarea { resize: vertical; min-height: 90px; }

    .form-error {
      font-size: 0.75rem; color: #c0392b;
      background: rgba(192,57,43,0.06);
      border: 1px solid rgba(192,57,43,0.15);
      border-radius: 7px; padding: 0.6rem 0.8rem;
      margin-top: 0.75rem;
    }
    .form-error.hidden { display: none; }

    .submit-wrap { margin-top: 1.5rem; }

    .btn-submit {
      display: inline-flex; align-items: center; gap: 0.5rem;
      padding: 0.8rem 2rem;
      background: var(--red); color: #fff;
      border: none; border-radius: 9px;
      font-family: var(--mono); font-size: 0.85rem;
      cursor: pointer; transition: background 0.14s, transform 0.1s;
    }
    .btn-submit:hover:not(:disabled) { background: var(--red-mid); }
    .btn-submit:active:not(:disabled) { transform: translateY(1px); }
    .btn-submit:disabled { opacity: 0.45; cursor: not-allowed; }

    /* ── Success ─────────────────────────────────────── */
    .success {
      display: flex; flex-direction: column; gap: 1.25rem;
      padding-top: 0.5rem;
    }

    .s-icon {
      width: 56px; height: 56px; border-radius: 50%;
      background: var(--red); color: #fff;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.5rem; animation: pop 0.35s cubic-bezier(0.34,1.56,0.64,1);
    }
    @keyframes pop {
      from { transform: scale(0.5); opacity: 0; }
      to   { transform: scale(1);   opacity: 1; }
    }

    .s-heading {
      font-family: var(--serif); font-size: 1.6rem; font-weight: 400;
    }

    .s-para { font-size: 0.82rem; color: var(--ink); line-height: 1.75; max-width: 36ch; }

    .s-slot {
      font-size: 0.78rem; color: var(--muted);
      border-left: 2.5px solid var(--red); padding-left: 0.75rem;
      line-height: 1.6;
    }

    .s-gcal {
      display: inline-flex; align-items: center; gap: 0.5rem;
      padding: 0.65rem 1.4rem;
      border: 1px solid var(--red); border-radius: 8px;
      color: var(--red); font-family: var(--mono); font-size: 0.8rem;
      text-decoration: none; transition: all 0.14s;
    }
    .s-gcal:hover { background: var(--red); color: #fff; }

    .s-back {
      font-size: 0.75rem; color: var(--muted);
      text-decoration: none; transition: color 0.14s;
    }
    .s-back:hover { color: var(--black); }

    /* ── Duration picker ─────────────────────────────── */
    .dur-picker {
      display: flex; align-items: center; gap: 0.85rem;
      margin-bottom: 1.25rem;
    }
    .dur-label {
      font-size: 0.63rem; letter-spacing: 0.1em;
      text-transform: uppercase; color: var(--muted);
      white-space: nowrap;
    }
    .dur-btns { display: flex; gap: 0.35rem; }
    .dur-btn {
      padding: 0.3rem 0.75rem;
      border: 1px solid var(--border); border-radius: 20px;
      background: none; font-family: var(--mono); font-size: 0.71rem;
      color: var(--muted); cursor: pointer;
      transition: border-color 0.14s, color 0.14s, background 0.14s;
    }
    .dur-btn:hover { border-color: var(--red); color: var(--red); }
    .dur-btn.active { background: var(--red); border-color: var(--red); color: #fff; }

    /* ── Responsive ──────────────────────────────────── */
    @media (max-width: 700px) {
      html, body { height: auto; overflow: auto; }

      .page { height: auto; }

      .shell { grid-template-columns: 1fr; }

      .info {
        height: auto; overflow-y: visible;
        border-right: none; border-bottom: 1px solid var(--border);
        padding: 2rem 1.5rem;
        gap: 1.25rem;
      }

      .widget {
        height: auto; overflow-y: visible;
        justify-content: flex-start;
        padding: 2rem 1.5rem 3rem;
      }

      .t-btn { font-size: 0.9rem; }
    }
  </style>
</head>

<body>
  <main>
    <div class="page">
      <div class="shell">

        <!-- ═══ LEFT · Info ══════════════════════════ -->
        <aside class="info" aria-label="Meeting information">
          <a href="/"><img src="/images/logo.png" class="info-logo" alt="CAISH"></a>

          <span class="info-label">Book a meeting</span>

          <div>
            <h1 class="info-names">Gaurav &amp; Justin</h1>
            <p class="info-org">Meridian Cambridge</p>
          </div>

          <hr class="info-rule" aria-hidden="true">

          <ul class="info-meta">
            <li>
              <!-- clock -->
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
              </svg>
              <span id="meta-dur">30 minutes</span>
            </li>
            <li>
              <!-- video -->
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/>
              </svg>
              Google Meet &middot; link in invite
            </li>
            <li>
              <!-- calendar -->
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
              Mon&ndash;Fri
            </li>
          </ul>
        </aside>

        <!-- ═══ RIGHT · Widget ════════════════════════ -->
        <section class="widget" aria-label="Booking form">

          <!-- Breadcrumb -->
          <div class="crumbs" aria-label="Booking progress">
            <span class="crumb here" data-s="1">Date</span>
            <span class="crumb-sep" aria-hidden="true">›</span>
            <span class="crumb" data-s="2">Time</span>
            <span class="crumb-sep" aria-hidden="true">›</span>
            <span class="crumb" data-s="3">Details</span>
          </div>

          <!-- Step 1 · Date -->
          <div class="step on" id="s1">
            <div class="dur-picker" id="dur-picker">
              <span class="dur-label">Duration</span>
              <div class="dur-btns" role="group" aria-label="Meeting duration">
                <button class="dur-btn active" data-mins="30">30 min</button>
                <button class="dur-btn" data-mins="45">45 min</button>
                <button class="dur-btn" data-mins="60">1 hr</button>
              </div>
            </div>
            <div class="cal-header">
              <button class="cal-btn" id="cal-prev" aria-label="Previous month">&#8249;</button>
              <h2 class="cal-title" id="cal-title"></h2>
              <button class="cal-btn" id="cal-next" aria-label="Next month">&#8250;</button>
            </div>
            <div class="cal-grid" id="cal-grid" role="grid" aria-label="Select a date"></div>
          </div>

          <!-- Step 2 · Time -->
          <div class="step" id="s2">
            <button class="step-back" id="back1">&#8592; Back</button>
            <h2 class="step-title">Choose a time</h2>
            <p class="step-sub" id="s2-label"></p>
            <div class="times" id="times" role="group" aria-label="Available times"></div>
            <p class="tz">All times in UK time (GMT / BST)</p>
          </div>

          <!-- Step 3 · Details -->
          <div class="step" id="s3">
            <button class="step-back" id="back2">&#8592; Back</button>
            <h2 class="step-title">Your details</h2>
            <p class="step-sub" id="s3-label"></p>

            <form id="form" novalidate>
              <!-- Honeypot — spam trap, invisible to real users -->
              <div class="hp" aria-hidden="true">
                <label for="hp_f">Leave blank</label>
                <input type="text" name="hp_f" id="hp_f" tabindex="-1" autocomplete="off">
              </div>

              <div class="fields">
                <div class="field">
                  <label for="f-name">Full name <span class="req">*</span></label>
                  <input type="text" id="f-name" autocomplete="name" required placeholder="Jane Smith">
                </div>

                <div class="field">
                  <label for="f-email">Email <span class="req">*</span></label>
                  <input type="email" id="f-email" autocomplete="email" required placeholder="jane@example.com">
                </div>

                <div class="field">
                  <label for="f-topic">What would you like to discuss? <span class="req">*</span></label>
                  <textarea id="f-topic" rows="3" required placeholder="A few lines on what you'd like to cover…"></textarea>
                </div>
              </div>

              <div class="form-error hidden" id="form-err" role="alert"></div>

              <div class="submit-wrap">
                <button type="submit" class="btn-submit" id="btn-sub">
                  <span id="btn-lbl">Book meeting</span>
                  <span aria-hidden="true">&#8594;</span>
                </button>
              </div>
            </form>
          </div>

          <!-- Step 4 · Booked! -->
          <div class="step" id="s4">
            <div class="success">
              <div class="s-icon" aria-hidden="true">&#10003;</div>
              <h2 class="s-heading">You&rsquo;re booked!</h2>
              <p class="s-para">
                A Google Meet invite has been sent to your email with all the details.
                You can accept it to add the event to your calendar.
              </p>
              <p class="s-slot" id="s4-slot"></p>
              <a class="s-gcal" id="s4-gcal" href="#" target="_blank" rel="noopener noreferrer">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                View in Google Calendar
              </a>
              <a id="s4-cancel" href="#" class="s-back">Need to cancel? Email us</a>
              <a href="/" class="s-back">&#8592; Back to CAISH</a>
            </div>
          </div>

        </section>
      </div>
    </div>
  </main>

  <script>
  /* =====================================================================
   *  SETUP — Google Apps Script (one-time, ~5 min)
   * =====================================================================
   *
   *  HOW IT WORKS
   *  The booking page calls the GAS Web App in two ways:
   *
   *    GET  ?date=YYYY-MM-DD&mins=30  →  returns free slots for that day
   *                              by reading both Gaurav's and Justin's
   *                              calendars and finding mutual free time
   *                              across the full working day (9am–6pm).
   *                              mins defaults to 30; pass 45 or 60 for
   *                              longer meeting durations.
   *
   *    POST (JSON body)       →  creates the calendar event with a
   *                              Google Meet link and sends Accept/Decline
   *                              invites to everyone instantly.
   *                              Location is automatically set to
   *                              "Sidney Street" or "Google Meet" based
   *                              on whether either of you has an OOO /
   *                              remote / away event that day.
   *
   *  STEPS
   *  1. Go to https://script.google.com → New project
   *
   *  2. Enable the Calendar API:
   *     Services (left sidebar + icon) → Google Calendar API → Add
   *
   *  3. Share Justin's calendar with gaurav@meridiancambridge.org:
   *     Google Calendar → Justin's calendar → Settings → Share with
   *     specific people → gaurav@ → "See all event details"
   *
   *  4. Paste the entire script below (replace the myFunction stub):
   *
   *  ─── PASTE START ────────────────────────────────────────────────────
   *
   *  var GAURAV = 'gaurav@meridiancambridge.org';
   *  var JUSTIN = 'justin@meridiancambridge.org';
   *  var TZ     = 'Europe/London';
   *
   *  // Returns true if the calendar has an OOO/remote event that day
   *  function isAway(calId, date) {
   *    try {
   *      var events = CalendarApp.getCalendarById(calId).getEventsForDay(date);
   *      var OOO = /(out.of.office|ooo|remote|work.?from.?home|wfh|away|not.in.office|virtual)/i;
   *      for (var i = 0; i < events.length; i++) {
   *        if (OOO.test(events[i].getTitle())) return true;
   *      }
   *    } catch(e) {}
   *    return false;
   *  }
   *
   *  // Returns true if a slot [start, end) overlaps any event
   *  function conflicts(start, end, events) {
   *    for (var i = 0; i < events.length; i++) {
   *      var es = events[i].getStartTime(), ee = events[i].getEndTime();
   *      if (es < end && ee > start) return true;
   *    }
   *    return false;
   *  }
   *
   *  // GET ?date=YYYY-MM-DD&mins=30 → { ok, slots: [{h, m}, …] }
   *  function doGet(e) {
   *    try {
   *      var parts = (e.parameter.date || '').split('-').map(Number);
   *      var date  = new Date(parts[0], parts[1]-1, parts[2]);
   *      var mins  = parseInt(e.parameter.mins || '30', 10) || 30;
   *
   *      var gCal = CalendarApp.getCalendarById(GAURAV);
   *      var jCal = CalendarApp.getCalendarById(JUSTIN);
   *      var gEvs = gCal.getEventsForDay(date);
   *      var jEvs = jCal.getEventsForDay(date);
   *
   *      var slots = [];
   *      // Full working day: 9am–6pm, 30-min start increments
   *      for (var h = 9; h < 18; h++) {
   *        for (var m = 0; m < 60; m += 30) {
   *          var s = new Date(parts[0], parts[1]-1, parts[2], h, m, 0);
   *          var f = new Date(s.getTime() + mins * 60000);
   *          if (f.getHours() >= 19) continue; // don't run past 7pm
   *          if (!conflicts(s, f, gEvs) && !conflicts(s, f, jEvs)) {
   *            slots.push({ h: h, m: m });
   *          }
   *        }
   *      }
   *
   *      return ContentService
   *        .createTextOutput(JSON.stringify({ ok: true, slots: slots }))
   *        .setMimeType(ContentService.MimeType.JSON);
   *    } catch(err) {
   *      return ContentService
   *        .createTextOutput(JSON.stringify({ ok: false, e: String(err) }))
   *        .setMimeType(ContentService.MimeType.JSON);
   *    }
   *  }
   *
   *  // POST JSON → creates event, sends invites
   *  function doPost(e) {
   *    try {
   *      var d    = JSON.parse(e.postData.contents);
   *      var date = new Date(d.startISO);
   *      // d.mins holds the chosen meeting duration (30, 45, or 60)
   *
   *      var gauravAway = isAway(GAURAV, date);
   *      var justinAway = isAway(JUSTIN, date);
   *      var location   = (gauravAway || justinAway)
   *        ? 'Google Meet (see video link in invite)'
   *        : '53-54 Sidney Street, Cambridge, CB2 3HX (or Google Meet)';
   *
   *      Calendar.Events.insert({
   *        summary     : 'Meeting with Gaurav & Justin \u2013 ' + d.name,
   *        start       : { dateTime: d.startISO, timeZone: TZ },
   *        end         : { dateTime: d.endISO,   timeZone: TZ },
   *        location    : location,
   *        description : 'Requested by: ' + d.name + ' (' + d.email + ')\n'
   *                    + 'Topic: ' + d.topic,
   *        attendees   : [
   *          { email: GAURAV, organizer: true },
   *          { email: JUSTIN },
   *          { email: d.email },
   *        ],
   *        conferenceData: {
   *          createRequest: {
   *            requestId: 'meet-' + Date.now(),
   *            conferenceSolutionKey: { type: 'hangoutsMeet' }
   *          }
   *        },
   *        guestsCanSeeOtherGuests: true,
   *        guestsCanModify: false,
   *      }, GAURAV, { conferenceDataVersion: 1, sendUpdates: 'all' });
   *
   *      // NOTE: Booking notification emails are now sent by the Netlify
   *      // function (book.js) via Resend, NOT by GAS. This avoids the
   *      // Gmail self-send suppression issue where the organizer never
   *      // receives a notification. You can remove the GmailApp.sendEmail
   *      // block from your deployed GAS script if it's still there.
   *
   *      return ContentService
   *        .createTextOutput(JSON.stringify({ ok: true }))
   *        .setMimeType(ContentService.MimeType.JSON);
   *    } catch(err) {
   *      return ContentService
   *        .createTextOutput(JSON.stringify({ ok: false, e: String(err) }))
   *        .setMimeType(ContentService.MimeType.JSON);
   *    }
   *  }
   *
   *  ─── PASTE END ──────────────────────────────────────────────────────
   *
   *  5. Deploy → New deployment
   *     · Type: Web App
   *     · Execute as: Me (gaurav@meridiancambridge.org)
   *     · Who has access: Anyone
   *     → Copy the Web App URL
   *
   *  6. Paste it as CONFIG.gasUrl below
   * ================================================================== */
  const CONFIG = {
    gasUrl:      'https://script.google.com/macros/s/AKfycbyGpHWJ9mztPGSKUKphCowZK0w9cG5SPNJQPTO00rnENxyH2JohqsFumBDJZjvs2Olm/exec',
    meetingMins: 30,   // updated dynamically when user picks duration
  };

  /* Per-date slot cache so we don't re-fetch if user goes back */
  const SLOT_CACHE = {};

  /* App state */
  const S = {
    calYear: null, calMonth: null,
    date: null, slot: null,
    calLink: null,
    formAt: 0,
    duration: 30,   // selected meeting duration in minutes
  };

  /* Utilities */
  const $   = id => document.getElementById(id);
  const pad = n  => String(n).padStart(2, '0');

  function today0() {
    const d = new Date(); d.setHours(0,0,0,0); return d;
  }
  function maxDate() {
    const d = today0(); d.setDate(d.getDate() + 42); return d;
  }
  function fmtDate(d) {
    return d.toLocaleDateString('en-GB', {
      weekday:'long', day:'numeric', month:'long', year:'numeric'
    });
  }
  function fmtTime(h, m) {
    const suffix = h >= 12 ? 'PM' : 'AM';
    return `${h%12||12}:${pad(m)} ${suffix}`;
  }

  /* ── Calendar ──────────────────────────────────── */
  function initCal() {
    const now = new Date();
    S.calYear = now.getFullYear();
    S.calMonth = now.getMonth();
    renderCal();
  }

  function renderCal() {
    const t   = today0();
    const max = maxDate();
    const y = S.calYear, m = S.calMonth;
    const first = new Date(y, m, 1);
    const last  = new Date(y, m+1, 0);

    $('cal-title').textContent = first.toLocaleDateString('en-GB', {
      month: 'long', year: 'numeric'
    });

    $('cal-prev').disabled = (y === t.getFullYear() && m === t.getMonth());
    $('cal-next').disabled = new Date(y, m+1, 1) > max;

    const HEADS = ['Mo','Tu','We','Th','Fr','Sa','Su'];
    let startOff = first.getDay(); // 0=Sun
    startOff = (startOff + 6) % 7; // 0=Mon

    let html = '';
    HEADS.forEach(h => { html += `<div class="cal-dh">${h}</div>`; });

    let day = 1;
    for (let row = 0; row < 6; row++) {
      if (day > last.getDate()) break;
      for (let col = 0; col < 7; col++) {
        const idx = row*7+col;
        if (idx < startOff || day > last.getDate()) {
          html += '<div></div>';
        } else {
          const d    = new Date(y, m, day);
          const dow  = d.getDay();
          const wknd = dow===0||dow===6;
          const past = d < t;
          const far  = d > max;
          const ok   = !wknd && !past && !far;
          const isToday = d.toDateString() === t.toDateString();
          const isSel   = S.date && d.toDateString() === S.date.toDateString();
          const ds   = `${y}-${pad(m+1)}-${pad(day)}`;
          const lbl  = d.toLocaleDateString('en-GB', {weekday:'long',day:'numeric',month:'long'});

          let cls = 'cal-day';
          if (ok) cls += ' avail';
          if (isSel) cls += ' sel';
          if (isToday && !isSel) cls += ' ring';

          if (ok) {
            html += `<button class="${cls}" data-d="${ds}" aria-label="${lbl}">${day}</button>`;
          } else {
            html += `<div class="${cls}" aria-hidden="true">${day}</div>`;
          }
          day++;
        }
      }
    }

    $('cal-grid').innerHTML = html;

    $('cal-grid').querySelectorAll('button.avail').forEach(btn => {
      btn.addEventListener('click', () => {
        const [yr,mo,dy] = btn.dataset.d.split('-').map(Number);
        S.date = new Date(yr, mo-1, dy);
        onDatePicked(btn.dataset.d);
      });
    });
  }

  /* ── Fetch slots from GAS (GET ?date=YYYY-MM-DD&mins=N) ── */
  async function fetchSlots(dateStr) {
    const cacheKey = `${dateStr}_${S.duration}`;
    if (SLOT_CACHE[cacheKey]) return SLOT_CACHE[cacheKey];

    const configured = CONFIG.gasUrl !== 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL';
    let slots;

    if (configured) {
      const res  = await fetch(`/api/book?date=${dateStr}&mins=${S.duration}`);
      const data = await res.json();
      if (!data.ok) throw new Error(data.e || 'Could not load availability.');
      slots = data.slots;
    } else {
      // Dev fallback: full working day slots every 30 min, 9am–5:30pm
      slots = [];
      for (let h = 9; h < 18; h++) {
        for (let m = 0; m < 60; m += 30) {
          // Don't offer a slot if the meeting would end after 7pm
          const endH = h + Math.floor((m + S.duration) / 60);
          if (endH >= 19) continue;
          slots.push({ h, m });
        }
      }
    }

    SLOT_CACHE[cacheKey] = slots;
    return slots;
  }

  async function onDatePicked(dateStr) {
    // Show step 2 immediately with a loading state
    go(2);
    $('s2-label').textContent = fmtDate(S.date);
    $('times').innerHTML = '<p class="t-loading">Checking availability\u2026</p>';

    try {
      const slots = await fetchSlots(dateStr);
      renderTimes(slots);
    } catch(err) {
      $('times').innerHTML =
        '<p style="color:var(--muted);font-size:.82rem">'
        + 'Could not load availability. Try another date or '
        + '<a href="mailto:hello@cambridgeaisafety.org" '
        + 'style="color:var(--red);text-decoration:underline">contact us directly</a>.'
        + '</p>';
    }
  }

  /* ── Render time slot buttons ──────────────────── */
  function renderTimes(slots) {
    if (!slots || !slots.length) {
      $('times').innerHTML =
        '<p style="color:var(--muted);font-size:.82rem">'
        + 'No availability on this day \u2014 please pick another date.'
        + '</p>';
      return;
    }

    $('times').innerHTML = slots.map(sl =>
      `<button class="t-btn" data-h="${sl.h}" data-m="${sl.m}">
        <span>${fmtTime(sl.h, sl.m)}</span>
        <span class="t-arrow">&#8594;</span>
      </button>`
    ).join('');

    $('times').querySelectorAll('.t-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        S.slot = { h: +btn.dataset.h, m: +btn.dataset.m };
        go(3);
      });
    });
  }

  /* ── Form init ─────────────────────────────────── */
  function initForm() {
    $('s3-label').textContent =
      `${fmtDate(S.date)} · ${fmtTime(S.slot.h, S.slot.m)}`;
    S.formAt = Date.now();
    showErr('');
  }

  /* ── Google Calendar link ──────────────────────── */
  function buildCalLink(name, email, topic) {
    const start = new Date(S.date);
    start.setHours(S.slot.h, S.slot.m, 0, 0);
    const end = new Date(start);
    end.setMinutes(end.getMinutes() + CONFIG.meetingMins);

    const fmt = d =>
      `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}`
      + `T${pad(d.getHours())}${pad(d.getMinutes())}00`;

    // No attendees — the real invite is sent by GAS. This is just a personal reminder link.
    return [
      'https://calendar.google.com/calendar/render?action=TEMPLATE',
      `text=${encodeURIComponent(`Meeting with Gaurav & Justin – ${name}`)}`,
      `dates=${fmt(start)}/${fmt(end)}`,
      `details=${encodeURIComponent(`Topic: ${topic}\n\nCheck your email for the Google Meet invite.`)}`,
      `location=${encodeURIComponent('53-54 Sidney Street, Cambridge, CB2 3HX (or Google Meet)')}`,
    ].join('&');
  }

  /* ── Error helper ──────────────────────────────── */
  function showErr(msg) {
    const el = $('form-err');
    el.textContent = msg;
    el.classList.toggle('hidden', !msg);
  }

  /* ── Form submit ───────────────────────────────── */
  $('form').addEventListener('submit', async e => {
    e.preventDefault();

    // Spam: honeypot
    if ($('hp_f').value) return;

    // Spam: timing (< 3 s = bot)
    if (Date.now() - S.formAt < 3000) {
      showErr('Please take a moment to fill in your details.');
      return;
    }

    // Spam: 24-hour rate limit — allow 2 bookings (in case someone needs to rebook after cancelling)
    const bkRaw = localStorage.getItem('caish_bk');
    let bkData = null;
    try { bkData = JSON.parse(bkRaw); } catch(_) { bkData = bkRaw ? { count: 1, first: Number(bkRaw) } : null; }
    if (bkData && bkData.count >= 2 && Date.now() - bkData.first < 86_400_000) {
      showErr("You've already made 2 booking requests today. Check your email, or write to us at hello@cambridgeaisafety.org.");
      return;
    }

    const name  = $('f-name').value.trim();
    const email = $('f-email').value.trim();
    const topic = $('f-topic').value.trim();

    if (!name || !email || !topic) { showErr('Please fill in all fields.'); return; }
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showErr('Please enter a valid email address.'); return; }

    // Disable button
    const btn = $('btn-sub');
    btn.disabled = true;
    $('btn-lbl').textContent = 'Booking\u2026';
    showErr('');

    // Build times
    const start = new Date(S.date);
    start.setHours(S.slot.h, S.slot.m, 0, 0);
    const end = new Date(start);
    end.setMinutes(end.getMinutes() + CONFIG.meetingMins);

    S.calLink = buildCalLink(name, email, topic);

    const configured = CONFIG.gasUrl !== 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL';

    try {
      if (configured) {
        await fetch('/api/book', {
          method:  'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name, email, topic,
            startISO: start.toISOString(),
            endISO:   end.toISOString(),
            mins:     S.duration,
          }),
        });
      } else {
        // Dev mode — no GAS URL configured, skip network call and show success
        console.log('Dev mode: booking would be sent to GAS with', { name, email, topic,
          startISO: start.toISOString(), endISO: end.toISOString(), mins: S.duration });
      }

      const prevRaw = localStorage.getItem('caish_bk');
      let prev = null;
      try { prev = JSON.parse(prevRaw); } catch(_) { prev = prevRaw ? { count: 1, first: Number(prevRaw) } : null; }
      if (prev && Date.now() - prev.first < 86_400_000) {
        localStorage.setItem('caish_bk', JSON.stringify({ count: prev.count + 1, first: prev.first }));
      } else {
        localStorage.setItem('caish_bk', JSON.stringify({ count: 1, first: Date.now() }));
      }

      // Wire up success screen
      const slotLabel = `${fmtDate(S.date)} · ${fmtTime(S.slot.h, S.slot.m)}`;
      $('s4-slot').textContent = slotLabel;
      $('s4-gcal').href = S.calLink;
      $('s4-cancel').href = `mailto:gaurav@meridiancambridge.org?subject=${encodeURIComponent('Cancel meeting – ' + slotLabel)}&body=${encodeURIComponent('Hi Gaurav,\n\nI would like to cancel my meeting on ' + slotLabel + '.\n\nThanks')}`;

      go(4);

    } catch(err) {
      console.error(err);
      showErr('Something went wrong. Please email hello@cambridgeaisafety.org directly.');
      btn.disabled = false;
      $('btn-lbl').textContent = 'Book meeting';
    }
  });

  /* ── Step navigation ───────────────────────────── */
  function go(n) {
    document.querySelectorAll('.step').forEach(el => el.classList.remove('on'));
    $(`s${n}`).classList.add('on');

    document.querySelectorAll('.crumb').forEach(el => {
      const sn = +el.dataset.s;
      el.classList.remove('here','done');
      if (sn === n) el.classList.add('here');
      else if (sn < n) el.classList.add('done');
    });

    if (n===1) renderCal();
    // n===2: slots are loaded by onDatePicked; going back just shows whatever was cached
    if (n===3) initForm();
  }

  $('back1').addEventListener('click', () => go(1));
  // Back from details: re-show the cached time slots for the already-picked date
  $('back2').addEventListener('click', () => {
    go(2);
    $('s2-label').textContent = fmtDate(S.date);
    const ds = `${S.date.getFullYear()}-${pad(S.date.getMonth()+1)}-${pad(S.date.getDate())}`;
    renderTimes(SLOT_CACHE[`${ds}_${S.duration}`] || []);
  });

  $('cal-prev').addEventListener('click', () => {
    S.calMonth--;
    if (S.calMonth < 0) { S.calMonth = 11; S.calYear--; }
    renderCal();
  });
  $('cal-next').addEventListener('click', () => {
    S.calMonth++;
    if (S.calMonth > 11) { S.calMonth = 0; S.calYear++; }
    renderCal();
  });

  /* ── Duration picker ───────────────────────────── */
  document.querySelectorAll('.dur-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const mins = +btn.dataset.mins;
      if (mins === S.duration) return;
      S.duration = mins;
      CONFIG.meetingMins = mins;
      // Flush cache — different duration changes which slots are free
      Object.keys(SLOT_CACHE).forEach(k => delete SLOT_CACHE[k]);
      document.querySelectorAll('.dur-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      // Update left-panel meta label
      $('meta-dur').textContent = mins === 60 ? '1 hour' : `${mins} minutes`;
    });
  });

  /* ── Boot ──────────────────────────────────────── */
  initCal();
  </script>
</body>
</html>

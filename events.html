<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="CAISH Events - Upcoming talks, socials, and workshops at Cambridge AI Safety Hub.">
  <title>Events | Cambridge AI Safety Hub</title>

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://cambridgeaisafety.org/events">
  <meta property="og:title" content="Events | Cambridge AI Safety Hub">
  <meta property="og:description" content="Upcoming talks, socials, and workshops at Cambridge AI Safety Hub.">
  <meta property="og:image" content="https://cambridgeaisafety.org/images/og-image.png">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://cambridgeaisafety.org/events">
  <meta name="twitter:title" content="Events | Cambridge AI Safety Hub">
  <meta name="twitter:description" content="Upcoming talks, socials, and workshops at Cambridge AI Safety Hub.">
  <meta name="twitter:image" content="https://cambridgeaisafety.org/images/og-image.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <link rel="apple-touch-icon" href="/images/favicon.png">

  <!-- DNS Prefetch & Preconnect -->
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
  <link rel="dns-prefetch" href="https://lu.ma">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- Preload critical resources -->
  <link rel="preload" href="/styles.css?v=20260113" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="/images/logo.png" as="image">
  <link rel="preload" href="https://fonts.gstatic.com/s/librebaskerville/v16/kmKnZrc3Hgbbcjq75U4uslyuy4kqN-INsyY.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="https://fonts.gstatic.com/s/spacemono/v14/i7dPIFZifjKcF5UAWdDRYEF8RQ.woff2" as="font" type="font/woff2" crossorigin>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Space+Mono:wght@400&display=swap" rel="stylesheet">

  <!-- Critical CSS - Inline for instant first paint -->
  <style>
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    html{font-size:16px;-webkit-font-smoothing:antialiased}
    body{font-family:'Space Mono',monospace;background:#fff;color:#1a1a1a;line-height:1.8}
    h1,h2,h3{font-family:'Libre Baskerville',Georgia,serif;font-weight:400}
    h1{font-size:clamp(2rem,4vw,3rem);line-height:1.2}
    nav{position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(255,255,255,0.92);border-bottom:1px solid rgba(224,224,224,0.7);backdrop-filter:blur(12px)}
    .nav-inner{display:flex;justify-content:space-between;align-items:center;padding:1rem 2.5rem;max-width:1000px;margin:0 auto}
    .logo{height:32px;opacity:0.9}
    .nav-links{display:flex;gap:2.5rem;list-style:none}
    .nav-links a{font-size:0.75rem;color:#4a4a4a;text-decoration:none}
    .page-header{max-width:1000px;margin:0 auto;padding:9rem 2.5rem 4rem}
    .label{font-size:0.6rem;letter-spacing:0.3em;text-transform:uppercase;color:#4a4a4a;margin-bottom:1.5rem;display:block}
    p{font-size:0.95rem;max-width:52ch;color:#4a4a4a}
    .skip-link{position:absolute;top:-40px;left:0;background:#1a1a1a;color:#fefefe;padding:8px 16px;z-index:100}
    .nav-toggle{display:none}
    @media(max-width:600px){.nav-links{display:none}.nav-toggle{display:block;background:none;border:none;cursor:pointer;padding:0.5rem}.nav-toggle span{display:block;width:24px;height:2px;background:#1a1a1a;margin:5px 0}.page-header{padding-top:6rem}}
  </style>

  <!-- Styles (async) -->
  <noscript><link rel="stylesheet" href="/styles.css?v=20260113"></noscript>

  <!-- Enhancements -->
  <script src="/enhancements.js?v=20260113" defer fetchpriority="low"></script>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      });
    }
  </script>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <nav>
    <div class="nav-inner">
      <a href="/" aria-label="Home">
        <img src="/images/logo.png" class="logo" width="50" height="50">
      </a>
      <ul class="nav-links">
        <li><a href="/fellowship">Alignment Fellowship</a></li>
        <li><a href="/desk">Alignment Desk</a></li>
        <li><a href="/mars">MARS</a></li>
        <li><a href="/events" class="active">Events</a></li>
        <li><a href="/about">About</a></li>
      </ul>
      <button class="nav-toggle" aria-label="Open menu" id="nav-toggle">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>

  <div id="mobile-nav" class="mobile-nav">
    <button class="mobile-nav-close" aria-label="Close menu" id="mobile-nav-close">&times;</button>
    <ul>
      <li><a href="/fellowship">Alignment Fellowship</a></li>
      <li><a href="/desk">Alignment Desk</a></li>
      <li><a href="/mars">MARS</a></li>
      <li><a href="/events" class="active">Events</a></li>
      <li><a href="/about">About</a></li>
    </ul>
  </div>

  <main>
  <section class="page-header page-header--socials" id="main-content">
    <h1>Events</h1>
    <p>Join us for regular events, speaker sessions, and hackathons.</p>
  </section>

  <div class="divider"><div class="divider-line"></div></div>

  <section class="socials-section">
    <div class="socials-content">
      <div id="events-container">
        <div class="events-loading">
          <p>Loading events...</p>
        </div>
      </div>
    </div>
  </section>

  <section class="expectations-section">
    <p class="expectations-note">Before attending our events, please read our <a href="https://docs.google.com/document/d/1GLTRKqqKpNh8Lxz4BSENwC_Xy9F7khFI/edit?usp=sharing&ouid=115324726254405066524&rtpof=true&sd=true">code of conduct</a>.</p>
    <p class="expectations-note" style="margin-top: 1rem;">For any questions about our events, please email hello (at) cambridgeaisafety (dot) org.</p>
  </section>

  <section class="socials-image">
    <img src="/images/community-min.png" alt="CAISH community members at an event" loading="lazy" decoding="async" width="800" height="500">
  </section>
  </main>

  <!-- Back to Top Button -->
  <button class="back-to-top" aria-label="Back to top">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="18 15 12 9 6 15"></polyline>
    </svg>
  </button>

  <footer>
    <div class="footer-inner">
      <div class="footer-legal">
        Cambridge AI Safety Hub is a project of <a href="https://find-and-update.company-information.service.gov.uk/company/13653958" target="_blank" rel="noopener">Meridian Impact CIC</a>, a Community Interest Company registered at Companies House (company number 13653958).
      </div>
      <span class="footer-copy">&copy; 2026 CAISH</span>
    </div>
  </footer>

  <script>
    // Mobile Navigation
    const MobileNav = {
      init() {
        const nav = document.getElementById('mobile-nav');
        const toggle = document.getElementById('nav-toggle');
        const close = document.getElementById('mobile-nav-close');

        toggle?.addEventListener('click', () => nav?.classList.add('active'));
        close?.addEventListener('click', () => nav?.classList.remove('active'));
        nav?.querySelectorAll('a').forEach(a => a.addEventListener('click', () => nav.classList.remove('active')));
      }
    };

    // Events Loading
    const EventsLoader = {
      dateOpts: { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' },
      timeOpts: { hour: '2-digit', minute: '2-digit' },

      escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return '';
        return unsafe
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      },

      sanitizeUrl(url) {
        if (!url || typeof url !== 'string') return '#';
        try {
          const parsed = new URL(url, window.location.origin);
          return ['http:', 'https:'].includes(parsed.protocol) ? url : '#';
        } catch {
          return '#';
        }
      },

      async init() {
        const container = document.getElementById('events-container');
        if (!container) return;

        try {
          const response = await fetch('/.netlify/functions/events');
          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || 'Failed to load events');
          }

          this.renderEvents(container, data.events);
        } catch (error) {
          console.error('Error loading events:', error);
          container.innerHTML = `
            <div class="events-empty">
              <p>Unable to load events at this time. Please try again later.</p>
            </div>
          `;
        }
      },

      formatDate(dateString) {
        return new Date(dateString).toLocaleDateString('en-GB', this.dateOpts);
      },

      formatTime(dateString) {
        return new Date(dateString).toLocaleTimeString('en-GB', this.timeOpts);
      },

      isUpcoming(dateString) {
        return new Date(dateString) >= new Date();
      },

      renderEvents(container, events) {
        if (!events || events.length === 0) {
          container.innerHTML = `
            <div class="events-empty">
              <p>No upcoming events at the moment. Check back soon!</p>
            </div>
          `;
          return;
        }

        // Separate upcoming and past events (single pass)
        const now = new Date();
        const upcoming = [];
        const past = [];
        for (const e of events) {
          const evt = e.event || e;
          const startTime = new Date(evt.start_at || evt.start_time);
          (startTime >= now ? upcoming : past).push(e);
        }

        let html = '';
        const rsvpNote = '<p class="events-rsvp">Please RSVP via Luma so we can plan for how many people are coming.</p>';

        if (upcoming.length > 0) {
          html += '<h2>Upcoming Events</h2>';
          html += rsvpNote;
          html += '<div class="events-grid">';
          upcoming.forEach(entry => {
            html += this.renderEventCard(entry, false);
          });
          html += '</div>';
        }

        if (past.length > 0) {
          html += '<h2 class="past-events-heading">Recent Events</h2>';
          html += '<div class="events-grid past-events">';
          past.forEach(entry => {
            html += this.renderEventCard(entry, true);
          });
          html += '</div>';
        }

        if (upcoming.length === 0 && past.length === 0) {
          html = `
            <div class="events-empty">
              <p>No events to display. Check back soon!</p>
            </div>
          `;
        }

        container.innerHTML = html;
        this.setupReadMore();
      },

      renderEventCard(entry, isPast) {
        const event = entry.event || entry;
        const name = event.name || 'Untitled Event';
        const description = event.description || '';
        const startAt = event.start_at || event.start_time;
        const endAt = event.end_at || event.end_time;
        const rawUrl = event.url || (event.api_id ? `https://lu.ma/${event.api_id}` : '#');
        const url = this.sanitizeUrl(rawUrl);
        const coverUrl = event.cover_url || event.cover_image_url || '';
        const location = event.geo_address_info?.city || event.location || 'Cambridge';

        const dateStr = this.formatDate(startAt);
        const timeStr = this.formatTime(startAt);
        const endTimeStr = endAt ? this.formatTime(endAt) : '';

        const truncatedDesc = description.substring(0, 100);
        const hasMore = description.length > 100;

        return `
          <a href="${this.escapeHtml(url)}" target="_blank" rel="noopener" class="event-card ${isPast ? 'past' : ''}">
            ${coverUrl ? `<div class="event-cover"><img src="${this.escapeHtml(coverUrl)}" loading="lazy" decoding="async" alt="${this.escapeHtml(name)}"></div>` : ''}
            <div class="event-content">
              <div class="event-date">
                <span class="event-day">${this.escapeHtml(dateStr)}</span>
                <span class="event-time">${this.escapeHtml(timeStr)}${endTimeStr ? ' - ' + this.escapeHtml(endTimeStr) : ''}</span>
              </div>
              <h3 class="event-title">${this.escapeHtml(name)}</h3>
              ${description ? `
                <div class="event-description-wrapper" data-full="${this.escapeHtml(description)}" data-truncated="${this.escapeHtml(truncatedDesc)}${hasMore ? '...' : ''}">
                  <p class="event-description">${this.escapeHtml(truncatedDesc)}${hasMore ? '...' : ''}</p>
                  ${hasMore ? '<span class="event-read-more">Read more</span>' : ''}
                </div>
              ` : ''}
              <div class="event-meta">
                <span class="event-location">${this.escapeHtml(location)}</span>
                <span class="event-link">View on Luma</span>
              </div>
            </div>
          </a>
        `;
      },

      setupReadMore() {
        document.querySelectorAll('.event-read-more').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const wrapper = btn.closest('.event-description-wrapper');
            const descEl = wrapper.querySelector('.event-description');
            const isExpanded = wrapper.classList.contains('expanded');

            if (isExpanded) {
              descEl.textContent = wrapper.dataset.truncated;
              btn.textContent = 'Read more';
              wrapper.classList.remove('expanded');
            } else {
              descEl.textContent = wrapper.dataset.full;
              btn.textContent = 'Show less';
              wrapper.classList.add('expanded');
            }
          });
        });
      }
    };

    const runIdle = (fn) => {
      if ('requestIdleCallback' in window) {
        requestIdleCallback(fn, { timeout: 1500 });
      } else {
        setTimeout(fn, 1);
      }
    };

    const BackToTop = {
      init() {
        const btn = document.querySelector('.back-to-top');
        if (!btn) return;
        window.addEventListener('scroll', () => {
          btn.classList.toggle('visible', window.scrollY > 400);
        }, { passive: true });
        btn.addEventListener('click', () => {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      }
    };

    // Initialize
    document.readyState === 'loading'
      ? document.addEventListener('DOMContentLoaded', () => {
          MobileNav.init();
          BackToTop.init();
          runIdle(() => EventsLoader.init());
        })
      : (() => {
          MobileNav.init();
          BackToTop.init();
          runIdle(() => EventsLoader.init());
        })();
  </script>
</body>
</html>
